name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
          - os: ubuntu-latest
            rid: linux-x64
          - os: macos-latest
            rid: osx-x64
          - os: macos-latest
            rid: osx-arm64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Publish
        run: |
          dotnet publish ./DvdExtrasRenamer/DvdExtrasRenamer.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -o publish

      # ==============================
      # WINDOWS & LINUX ZIP
      # ==============================
      - name: Zip (Windows)
        if: runner.os == 'Windows'
        run: |
          Compress-Archive -Path publish/* -DestinationPath DvdExtrasRenamer-${{ github.ref_name }}-${{ matrix.rid }}.zip

      - name: Zip (Linux)
        if: runner.os == 'Linux'
        run: |
          cd publish
          zip -r ../DvdExtrasRenamer-${{ github.ref_name }}-${{ matrix.rid }}.zip .

      # ==============================
      # MACOS .APP BUNDLE
      # ==============================
      - name: Create macOS .app bundle
        if: runner.os == 'macOS'
        run: |
          APP_NAME=DvdExtrasRenamer
          VERSION=${{ github.ref_name }}

          mkdir -p "$APP_NAME.app/Contents/MacOS"
          mkdir -p "$APP_NAME.app/Contents/Resources"

          mv publish/$APP_NAME "$APP_NAME.app/Contents/MacOS/$APP_NAME"

          cat > "$APP_NAME.app/Contents/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
           "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>$APP_NAME</string>
              <key>CFBundleDisplayName</key>
              <string>$APP_NAME</string>
              <key>CFBundleIdentifier</key>
              <string>com.yourname.dvdextrasrenamer</string>
              <key>CFBundleVersion</key>
              <string>$VERSION</string>
              <key>CFBundleShortVersionString</key>
              <string>$VERSION</string>
              <key>CFBundleExecutable</key>
              <string>$APP_NAME</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSMinimumSystemVersion</key>
              <string>11.0</string>
          </dict>
          </plist>
          EOF

          chmod +x "$APP_NAME.app/Contents/MacOS/$APP_NAME"

      - name: Zip macOS app
        if: runner.os == 'macOS'
        run: |
          ditto -c -k --sequesterRsrc --keepParent \
            DvdExtrasRenamer.app \
            DvdExtrasRenamer-${{ github.ref_name }}-${{ matrix.rid }}.zip

      # ==============================
      # UPLOAD ARTIFACT
      # ==============================
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: DvdExtrasRenamer-${{ github.ref_name }}-${{ matrix.rid }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
