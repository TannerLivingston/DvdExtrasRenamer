<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:DvdExtrasRenamer.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="900"
        x:Class="DvdExtrasRenamer.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="DvdExtrasRenamer"
        Width="1000"
        Height="1000"
        Background="#F5F5F5">

    <Window.Styles>
        <Style Selector="TextBox">
            <Setter Property="Background" Value="White" />
            <Setter Property="Foreground" Value="#1A1A1A" />
            <Setter Property="BorderBrush" Value="#007AFF" />
            <Setter Property="BorderThickness" Value="2" />
            <Setter Property="CaretBrush" Value="#1A1A1A" />
            <Setter Property="Padding" Value="8,6" />
        </Style>
        <Style Selector="TextBox:focus">
            <Setter Property="Background" Value="White" />
            <Setter Property="Foreground" Value="#1A1A1A" />
            <Setter Property="BorderBrush" Value="#0051C3" />
            <Setter Property="BorderThickness" Value="2" />
            <Setter Property="CaretBrush" Value="#1A1A1A" />
        </Style>
        <Style Selector="TextBox:pointerover">
            <Setter Property="Background" Value="White" />
            <Setter Property="Foreground" Value="#1A1A1A" />
            <Setter Property="BorderBrush" Value="#007AFF" />
        </Style>
        <!-- Base Button -->
        <Style Selector="Button">
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="CornerRadius" Value="6" />
        </Style>

        <!-- Primary Button -->
        <Style Selector="Button.primaryButton">
            <Setter Property="Background" Value="#007AFF" />
            <Setter Property="Foreground" Value="White" />
        </Style>

        <Style Selector="Button.primaryButton:pointerover">
            <Setter Property="Background" Value="#005FCC" />
        </Style>

        <Style Selector="Button.primaryButton:pressed">
            <Setter Property="Background" Value="#004999" />
        </Style>

        <!-- Subtle Danger Outline Button -->
        <Style Selector="Button.dangerOutlineButton">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="#FF3B30" />
            <Setter Property="BorderBrush" Value="#FF3B30" />
            <Setter Property="BorderThickness" Value="1.5" />
        </Style>

        <Style Selector="Button.dangerOutlineButton:pointerover">
            <Setter Property="Background" Value="#FF3B30" />
            <Setter Property="Foreground" Value="White" />
        </Style>

        <Style Selector="Button.dangerOutlineButton:pressed">
            <Setter Property="Background" Value="#CC2E26" />
            <Setter Property="Foreground" Value="White" />
        </Style>

        <!-- Subtle pulse on progress bar wrapper while matching so it's clear the app didn't freeze -->
        <Style Selector="Border.matchingInProgress">
            <Style.Animations>
                <Animation Duration="0:0:1.4" IterationCount="INFINITE" PlaybackDirection="Alternate"
                           Easing="SineEaseInOut">
                    <KeyFrame Cue="0%">
                        <Setter Property="Opacity" Value="0.72" />
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="Opacity" Value="1.0" />
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>

    </Window.Styles>

    <Design.DataContext>
        <vm:MainWindowViewModel />
    </Design.DataContext>

    <ScrollViewer Background="#F5F5F5">
        <StackPanel Margin="30" Spacing="15">
            <!-- Directory Selection Section -->
            <StackPanel Spacing="10">
                <TextBlock Text="Video Directory" FontWeight="Bold" FontSize="14" Foreground="#1A1A1A" />
                <StackPanel Orientation="Horizontal" Spacing="15" VerticalAlignment="Center">
                    <Button Name="OpenFileButton" Content="Browse Directory" Padding="12,10"
                            Click="OpenFileButton_Clicked" Background="#007AFF" Foreground="White" FontWeight="Bold" />
                    <TextBlock Name="FilePathTextBlock" TextWrapping="Wrap" Text="No directory selected" Width="650"
                               FontSize="14" VerticalAlignment="Center" Foreground="#333333" />
                </StackPanel>
            </StackPanel>

            <!-- DVD Lookup Section -->
            <Border BorderBrush="#D0D0D0" BorderThickness="0,1,0,0" Padding="0,15,0,0" />

            <StackPanel Spacing="8">
                <TextBlock Text="DVD Lookup" FontWeight="Bold" FontSize="14" Foreground="#1A1A1A" />

                <StackPanel Orientation="Horizontal" Spacing="15">
                    <StackPanel Width="400">
                        <TextBlock Text="Title" FontSize="12" Margin="0,0,0,4" Foreground="#333333" />
                        <TextBox Name="TitleTextBox"
                                 Text="{Binding Title}"
                                 Padding="8,6"
                                 FontSize="12"
                                 IsEnabled="{Binding IsLookupNotInProgress}" />
                    </StackPanel>
                    <StackPanel Width="100">
                        <TextBlock Text="Year" FontSize="12" Margin="0,0,0,4" Foreground="#333333" />
                        <TextBox Name="YearTextBox"
                                 Text="{Binding Year}"
                                 Padding="8,6"
                                 FontSize="12"
                                 IsEnabled="{Binding IsLookupNotInProgress}" />
                    </StackPanel>
                    <StackPanel Width="400">
                        <TextBlock Text="Director" FontSize="12" Margin="0,0,0,4" Foreground="#333333" />
                        <TextBox Name="DirectorTextBox"
                                 Text="{Binding Director}"
                                 Padding="8,6"
                                 FontSize="12"
                                 IsEnabled="{Binding IsLookupNotInProgress}" />
                    </StackPanel>
                </StackPanel>

                <Button Name="LookupButton" Content="Lookup DVD" Width="150" Padding="10,8"
                        Command="{Binding PerformLookupCommand}"
                        IsEnabled="{Binding IsLookupNotInProgress}"
                        Background="#007AFF" Foreground="White" FontWeight="Bold" />

                <TextBlock Name="SelectionOptions" Text="{Binding LookupResult}" FontSize="11" Foreground="#666666"
                           TextWrapping="Wrap" />
            </StackPanel>

            <!-- DVD Selection Section -->
            <StackPanel Spacing="8" IsVisible="{Binding Items.Count, Converter={x:Static ObjectConverters.IsNotNull}}">
                <TextBlock Text="Available DVDs" FontWeight="Bold" FontSize="12" Margin="0,10,0,0" Foreground="#1A1A1A" />
                <ScrollViewer MaxHeight="120" BorderBrush="#D0D0D0" BorderThickness="1" Background="White">
                    <ItemsControl ItemsSource="{Binding Items}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Content="{Binding Title}"
                                        Margin="4"
                                        Padding="6,4"
                                        FontSize="11"
                                        Classes="dvdButton"
                                        IsEnabled="{Binding DataContext.IsLookupNotInProgress, RelativeSource={RelativeSource FindAncestor, AncestorType=Window}}"
                                        Command="{Binding DataContext.SelectItemCommand, RelativeSource={RelativeSource FindAncestor, AncestorType=Window}}"
                                        CommandParameter="{Binding .}" />
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- DVD Selection Status -->
                <Border BorderBrush="#34C759" BorderThickness="1" Padding="10" CornerRadius="4" Background="#F0F9F5"
                        IsVisible="{Binding IsDvdSelected}">
                    <StackPanel Spacing="8">
                        <TextBlock Text="{Binding SelectedDvdTitle, StringFormat='DVD: {0}'}" FontWeight="Bold"
                                   FontSize="11" Foreground="#1A6B3B" />
                        <TextBlock Text="Click 'Match Videos' to scan your directory for matches." FontSize="10"
                                   Foreground="#333333" TextWrapping="Wrap" />
                        <Button Content="View on dvdcompare.net" Padding="0" Background="Transparent"
                                Foreground="#0066CC"
                                FontSize="10" Cursor="Hand" Command="{Binding OpenDvdLinkCommand}" />
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Match Results Section -->
            <Border BorderBrush="#D0D0D0" BorderThickness="0,1,0,0" Padding="0,15,0,0" />

            <StackPanel Spacing="8">
                <TextBlock Text="Video Matching Results" FontWeight="Bold" FontSize="14" Foreground="#1A1A1A" />

                <!-- Match Videos Button with Spinner -->
                <Grid ColumnDefinitions="Auto,12,*,12,Auto"
                      VerticalAlignment="Center">

                    <!-- Match Button -->
                    <Button Grid.Column="0"
                            Content="Match Videos"
                            Width="220"
                            Height="28"
                            Command="{Binding MatchVideosInDirectoryCommand}"
                            CommandParameter="{Binding SelectedDirectory}"
                            IsEnabled="{Binding IsDvdSelected}"
                            Classes="primaryButton" />

                    <!-- Progress Bar with pulse wrapper (animation runs on Border so it's visible) -->
                    <Border Grid.Column="2" CornerRadius="4" Padding="0"
                            Classes.matchingInProgress="{Binding IsMatchingInProgress}">
                        <ProgressBar Height="28"
                                     Minimum="0"
                                     Maximum="{Binding VideoCount}"
                                     Value="{Binding SelectedMatchIndex}"
                                     IsIndeterminate="False"
                                     VerticalAlignment="Center" />
                    </Border>

                    <!-- Cancel Button (Only visible while matching) -->
                    <Button Grid.Column="4"
                            Content="Cancel"
                            Width="100"
                            Height="28"
                            Command="{Binding CancelMatchOperationCommand}"
                            IsVisible="{Binding IsMatchingInProgress}"
                            Classes="dangerOutlineButton" />

                </Grid>


                <!-- Progress/Log TextBox (auto-scrolls to latest when MatchResults updates) -->
                <ScrollViewer x:Name="ProgressScrollViewer" Height="150" BorderBrush="#D0D0D0" BorderThickness="1"
                              Background="White">
                    <TextBlock Name="ProgressTextBlock"
                               Text="{Binding MatchResults}"
                               TextWrapping="Wrap"
                               FontSize="11"
                               FontFamily="Courier New"
                               Foreground="#1A1A1A"
                               Padding="8" />
                </ScrollViewer>

                <!-- Match List with Rename Buttons -->
                <TextBlock Text="Matched Videos"
                           FontSize="12"
                           Margin="0,10,0,5"
                           FontWeight="Bold"
                           Foreground="#1A1A1A"
                           IsVisible="{Binding MatchList.Count, Converter={x:Static ObjectConverters.IsNotNull}}" />

                <ScrollViewer MaxHeight="300"
                              HorizontalScrollBarVisibility="Disabled"
                              BorderBrush="#D0D0D0"
                              BorderThickness="1"
                              Background="White"
                              IsVisible="{Binding MatchList.Count, Converter={x:Static ObjectConverters.IsNotNull}}">

                    <ItemsControl ItemsSource="{Binding MatchList}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel>

                                    <!-- ================= ACTIVE (NOT RENAMED) ROW ================= -->
                                    <Grid Margin="4"
                                          ColumnDefinitions="Auto,*,Auto"
                                          VerticalAlignment="Center"
                                          IsVisible="{Binding IsNotRenamed}">

                                        <!-- SOURCE -->
                                        <StackPanel Grid.Column="0"
                                                    Orientation="Horizontal"
                                                    Spacing="6"
                                                    VerticalAlignment="Center"
                                                    Margin="0,0,10,0">

                                            <TextBlock Text="{Binding VideoFile}"
                                                       FontSize="11"
                                                       FontWeight="Bold"
                                                       Foreground="#1A1A1A"
                                                       TextTrimming="CharacterEllipsis"
                                                       MaxWidth="260" />

                                            <TextBlock Text="→"
                                                       FontSize="11"
                                                       Foreground="#666666" />
                                        </StackPanel>

                                        <!-- TARGET (flex column) -->
                                        <Grid Grid.Column="1"
                                              ColumnDefinitions="Auto,*,Auto"
                                              VerticalAlignment="Center"
                                              Margin="0,0,10,0">

                                            <!-- Collision Badge -->
                                            <Border Grid.Column="0"
                                                    Background="#FFF3E0"
                                                    Padding="4,2"
                                                    CornerRadius="4"
                                                    Margin="0,0,6,0"
                                                    VerticalAlignment="Center"
                                                    IsVisible="{Binding HasCollision}">
                                                <TextBlock Text="Multiple options"
                                                           FontSize="9"
                                                           Foreground="#E65100"
                                                           FontWeight="SemiBold" />
                                            </Border>

                                            <!-- Title -->
                                            <TextBlock Grid.Column="1"
                                                       Text="{Binding SelectedCandidateTitle}"
                                                       FontSize="11"
                                                       Foreground="#1A1A1A"
                                                       VerticalAlignment="Center"
                                                       TextTrimming="CharacterEllipsis"
                                                       IsVisible="{Binding HasCollision}" />

                                            <TextBlock Grid.Column="1"
                                                       Text="{Binding ExtraTitle}"
                                                       FontSize="11"
                                                       Foreground="#1A1A1A"
                                                       VerticalAlignment="Center"
                                                       TextTrimming="CharacterEllipsis"
                                                       IsVisible="{Binding !HasCollision}" />

                                            <!-- Dropdown -->
                                            <Button Grid.Column="2"
                                                    Content="▼"
                                                    Padding="6,2"
                                                    FontSize="10"
                                                    Margin="6,0,0,0"
                                                    IsEnabled="{Binding IsNotRenamed}"
                                                    ToolTip.Tip="Choose title"
                                                    Tag="{Binding .}"
                                                    IsVisible="{Binding HasCollision}">

                                                <Button.Flyout>
                                                    <Flyout Placement="Bottom"
                                                            Opened="TitlePickerFlyout_Opened">
                                                        <ListBox MinWidth="200"
                                                                 MaxHeight="220"
                                                                 ItemsSource="{Binding CandidateExtraTitles}"
                                                                 SelectedItem="{Binding SelectedCandidateTitle}"
                                                                 SelectionChanged="TitlePickerListBox_SelectionChanged" />
                                                    </Flyout>
                                                </Button.Flyout>
                                            </Button>
                                        </Grid>

                                        <!-- RENAME BUTTON (ALWAYS RIGHT) -->
                                        <Button Grid.Column="2"
                                                Content="Rename"
                                                Width="90"
                                                Padding="10,6"
                                                HorizontalContentAlignment="Center"
                                                VerticalAlignment="Center"
                                                Classes="primaryButton"
                                                Command="{Binding DataContext.RenameVideoCommand, RelativeSource={RelativeSource FindAncestor, AncestorType=Window}}"
                                                CommandParameter="{Binding .}"
                                                IsEnabled="{Binding IsNotRenamed}" />
                                    </Grid>

                                    <!-- ================= RENAMED ROW ================= -->
                                    <Grid Margin="4"
                                          ColumnDefinitions="Auto,*,Auto"
                                          VerticalAlignment="Center"
                                          Opacity="0.5"
                                          IsVisible="{Binding IsRenamed}">

                                        <!-- Source -->
                                        <Border Grid.Column="0"
                                                Padding="6,4"
                                                CornerRadius="4"
                                                Background="#F5F5F5"
                                                BorderBrush="#D0D0D0"
                                                BorderThickness="1"
                                                Margin="0,0,10,0">
                                            <TextBlock Text="{Binding VideoFile}"
                                                       FontSize="11"
                                                       FontWeight="Bold"
                                                       Foreground="#666666"
                                                       TextTrimming="CharacterEllipsis"
                                                       MaxWidth="260" />
                                        </Border>

                                        <!-- Target -->
                                        <Border Grid.Column="1"
                                                Padding="6,4"
                                                CornerRadius="4"
                                                Background="#F5F5F5"
                                                BorderBrush="#D0D0D0"
                                                BorderThickness="1"
                                                Margin="0,0,10,0">
                                            <TextBlock Text="{Binding ExtraTitle}"
                                                       FontSize="11"
                                                       Foreground="#666666"
                                                       TextTrimming="CharacterEllipsis" />
                                        </Border>
                                    </Grid>

                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                </ScrollViewer>

            </StackPanel>
        </StackPanel>
    </ScrollViewer>

</Window>
